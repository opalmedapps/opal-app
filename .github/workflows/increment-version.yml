# SPDX-FileCopyrightText: Copyright (C) 2025 Opal Health Informatics Group at the Research Institute of the McGill University Health Centre <john.kildea@mcgill.ca>
#
# SPDX-License-Identifier: Apache-2.0

name: Increment Version
run-name: Incrementing the app version using semantic-release
on:
  # Offer a manual interface to run semantic-release
  workflow_dispatch:
  # TODO testing
  push:
    branches:
      - SB.ci-semantic-release

permissions:
  contents: read

jobs:
  increment-version:
    steps:
      # Install dependencies
      - name: Install dependencies
        uses: ./.github/actions/install-dependencies
        with:
          NPMRC_FILE: ${{ inputs.NPMRC_FILE }}
        shell: bash

      # Set semantic-release author to our own bot user for correct attribution
      - name: Set the author as semantic-release
        run: |
          apk add --no-cache curl jq
          RESPONSE=$(curl -L -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${GH_TOKEN}" -H "X-GitHub-Api-Version: 2022-11-28" https://api.github.com/user/emails)
          echo "$RESPONSE"
          export GIT_AUTHOR_EMAIL=$(echo $RESPONSE | jq ".email")
          echo "$GIT_AUTHOR_EMAIL"
          export GIT_COMMITTER_EMAIL=$GIT_AUTHOR_EMAIL
          echo "$GIT_COMMITTER_EMAIL"
          echo "semantic-release-bot email is ${GIT_AUTHOR_EMAIL}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Increment the version
      - name: Run semantic-release
        run: npx semantic-release

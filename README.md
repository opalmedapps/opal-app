# Opal Patient Portal Application

Opal is a patient portal application for mobile devices and the web which originated from the winning project of
the 2014 MUHC Q+ initiative. The project proposal was submitted by the Health Informatics Group (HIG, now known as O-HIG) and was entitled
“Realistic knowledge-based waiting time estimates for radiation oncology patients - addressing the pain of waiting”.
It had as its goal the provision of waiting time estimates to radiation oncology patients.
The app has now extended past its original scope to provide appointments, lab results, clinical reports,
educational material and much more to patients, making it a full-fledged empowerment tool for those undergoing medical treatment.

## Table of contents

[[_TOC_]]

## Installation

The first section of these instructions will get you a copy of the Opal app running on your local machine
for development or testing purposes.

The app is built using [Cordova](https://cordova.apache.org/), which is a
mobile development framework that packages web code into mobile applications for iOS and Android.
This installation guide is therefore divided into two main sections:
[Web](#installing-building-and-serving-the-web-code) and
[Mobile app](#installing-building-and-serving-the-mobile-app-code).
The first section will help you set up the project to run Opal's web code in a browser, allowing for easy development without the overhead of building for mobile.
The second section will guide you towards building the app for a mobile device, as is done for its end users.

The app installed via this guide can be configured to communicate either with a server-hosted environment backend
(used for development, or production), or with a fully local environment installed on your own development machine.

### Repository Overview

The following is a high-level overview of the folders in this repository.
The most important folders to be aware of are the web source code in `src`, the compiled built web code in `www`,
and the platform specific code generated by Cordova for iOS and Android in `platforms`.

```plain
.
├── CHANGELOG.md # Description of changes per version
├── README.md
├── .gitlab # Contains templates used in GitLab
├── .gitlab-ci.yml # GitLab CI/CD pipeline description file
├── docs # Project-specific documentation
├── env # Contains folders configured to connect to any given backend environment
    ├── local
    └── etc.
├── firebase.json # Configuration used to deploy the password reset redirection webpage
├── hooks # Cordova hooks for the application
├── platforms # Platforms folder (generated by Cordova), where the compiled mobile code lives
├── plugins # Plugins folder (generated by Cordova), providing interfaces to native mobile functionality (GPS, file system, etc.)
├── node_modules # Dependencies folder (generated by npm)
├── .gitignore
├── opal-env.setup.js # Utility file managing environment setup when building or running the app
├── package-lock.json # Dependency installation record (generated by npm)
├── package.json # List of dependencies and build/execution scripts
├── static # Contains static pages such as the web app's landing page and the password reset redirection webpage
├── res # Contains app splashscreens and icons
├── src # This is where your source code lives
├── www  # Web code folder (generated by Webpack), where the compiled web code lives
└── webpack.config.js # Webpack configuration file
```

For information about versioning, please read [Versioning](https://gitlab.com/opalmedapps/qplus/-/wikis/Versioning).

### Web

1.  Node.js is required to run and build the app. Install Node.js version `20.11.X`, ideally via the [Node Version Manager for Mac](https://github.com/nvm-sh/nvm) or
    [Node Version Manager for Windows](https://github.com/coreybutler/nvm-windows) (`nvm`).
    Using `nvm` instead of installing Node.js directly greatly facilitates updates, and makes switching between versions convenient and easy.

    ```shell
    nvm list
    ```
    ```shell
    nvm install 20.11.0
    ```
    ```shell
    nvm use 20.11.0
    ```

    To verify that Node was set up correctly, run:
    ```shell
    node -v
    ```
   
    This installation also installs the Node.js package manager [npm](https://docs.npmjs.com/getting-started/what-is-npm),
    which is in charge of installing and managing all the libraries and dependencies required by the app.

2.  Install the app's dependencies

    ```shell
    npm install
    ```

    For a list of all the app's dependencies, refer to [package.json](./package.json).

    _Webpack_
    - [Webpack](https://webpack.js.org/) is a compiler & task manager that handles bundling the app and other common web code development task,
      such as:
        1. Controlling differences between environments: Webpack's [ProvidePlugin](https://webpack.js.org/plugins/provide-plugin/)
           allows us to specify environment variables in a file that is made available everywhere in the app.
        2. Emitting a [minified](https://webpack.js.org/plugins/terser-webpack-plugin/) version of the code.
        3. Compiling the code to an older version of JavaScript using [babel](https://babeljs.io/), which allows us to use
           the latest features from JavaScript without worrying about JavaScript compatibility on patients' devices.
        4. Optimizing the code in different ways.
      <br>
      For more information on _webpack_ see: https://survivejs.com/webpack/what-is-webpack/
    - [webpack-dev-server](https://webpack.js.org/configuration/dev-server/) is a web server which is used to serve Webpack's bundles
      from localhost while working on development.

3.  Connect your installation to a running backend.

    The Opal app requires connection to a running listener (and associated backend components) to be able to run and serve data upon login.

    Follow the instructions in [the env folder's README](./env/README.md) to configure a connection to a local or server-hosted backend.

4.  Run the app in a browser (the following command assumes you've configured an environment called `local`).

    ```shell
    npm run start --env=local
    ```

    This command will open a browser at the address `http://localhost:9000`, and once the app compiles, it will launch the app.
    A few notes:
      - Make sure port 9000 isn't used by your machine. If it's already in use, or if you'd like to spawn several Opal applications
        at the same time (using different ports), edit the `port` variable in `webpack.config.js` or add `--port=9001` (or other port number)
        to the right `webpack-dev-server` commands in `package.json`.
      - If the app looks normal (though stretched out, until you resize the window), with the Opal logo and buttons, your installation was successful.
        If the app looks jumbled (a green screen, untranslated labels, no buttons, etc.), the app code is fine, but the package installations
        failed --> skip ahead to [Troubleshooting](#troubleshooting).
      - Note that for performance reasons, the `webpack-dev-server` spawned when using `npm run start` compiles and builds the code _in memory_.
        This means that the code will not be compiled to the `www` folder which Cordova uses to build the app.
        If that's the desired outcome, use the following command to build and compile the app into the `www` folder instead:

        ```shell
        npm run build:web --env=local
        ```

        For more information on `webpack-dev-server`, go to: https://webpack.js.org/guides/development/ under the `webpack-dev-server` section.

9.  Try logging in; navigate to the login page and enter the following credentials:

    ```plain
    email: marge@opalmedapps.ca
    password: 12345Opal!!
    hospital (French): Établissement médical Opal (ÉMO)
    hospital (English): Opal Medical Institution (OMI)
    security answer (depending on the question): red, superman, meg
    ```

#### Notes on the development of web code

- We recommend the use of Chrome or Firefox as they have the best debug console, the Opal web code does not currently support Internet Explorer
- To debug the code, use the [developer console](https://developer.chrome.com/devtools), switch to mobile view and [disable caching](http://nicholasbering.ca/tools/2016/10/09/devtools-disable-caching/). Sometimes the browser caches pages disallowing developers from seeing change to the code.
- If you followed all the steps in [Installing Building and Serving web code](#installing-building-and-serving-the-web-code) correctly, the only errors you should see in the debug console are a 404 error for cordova.js, a 404 error for favicon.ico, and many warnings for translations that don't exist. Otherwise, skip ahead to [Troubleshooting](#troubleshooting).
**NOTE: In the past, several students have had trouble installing dependencies due to strange permission issues that block the ability to write to certain directories. Don't worry if this happens to you! Please consult the [Troubleshooting](#troubleshooting) section below.**

### Installing, building, and serving the mobile app code

#### Locally

1. Make sure you have followed the steps on [Installing, building, and serving the mobile web code](#installing-building-and-serving-the-web-code).

2. Install and set up Cordova for the desired target platforms by following the steps in the Android and iOS cordova environments: **Note: iOS may only be built by a machine with macOS as the operating system**
    - **Android**: https://cordova.apache.org/docs/en/latest/guide/platforms/android/index.html
    - **iOS**: https://cordova.apache.org/docs/en/latest/guide/platforms/ios/index.html

    Create an empty `www` folder in your project. Otherwise, you may get the following error from Cordova: `Current working directory is not a Cordova-based project.` This folder may be deleted and re-created if needed.

3. To build the app, run the following commands (if needed, replace `dev` with one of the folder names in `./env`
    to use a different environment). These commands make sure the Cordova plugins and platforms are up-to-date,
    build the web app and then run the `cordova build` command for Android or iOS, resulting in the compiled `platforms` folder.

    ```shell
    npm run build:app:ios --env=dev
    npm run build:app:android --env=dev
    ```

4. Finally, to run the app in an emulator, execute the following command. _Note_: on Mac, you may need to install
   cordova globally first (`npm install -g cordova`).

    ```shell
    cordova run [android|ios]
    ```

A few notes on this:

- If building for iOS you may need a developer profile in Apple depending on what you want to do. Running in an emulator does not require development profiles.
- Once the build commands have been run, the project becomes a valid Cordova project, which means you may use any of the [Cordova related cli commands](https://cordova.apache.org/docs/en/latest/reference/cordova-cli/).
   As mentioned above, on Mac, you may need to install cordova globally to access the CLI commands.
- Only the build commands containing the word `release` (typically used with the `prod` environment setting)
   are used to create production-ready application builds. All other commands produce builds suited for development.

The development apps allow debugging, among other security risks such as self-signed certificates.
To disable them, use the release mode: `cordova build --release --verbose`.
In particular, prod settings (`prod/config.xml`) and release mode should be used for builds that are sent in for penetration or security testing, to ensure that common security vulnerabilities such as debugging being enabled are not flagged.

#### Using CI/CD

As an alternative to setting up your computer to build the app locally, GitLab can be used to build the app for you,
providing you with the resulting output files directly in GitLab.

1. After committing your work on a personal branch, push the branch to GitLab.
   1. If you have an open merge request, you will see a box saying
      `Detached merge request pipeline #___ waiting for manual action`.
      Click on the gear icon on the right to reveal buttons with which to launch an iOS, Android or web build.
   2. If you don't have an open merge request, navigate to
      the [Pipelines page](https://gitlab.com/opalmedapps/qplus/-/pipelines).
      There, click to open the blocked pipeline corresponding to your latest commit, and use the play buttons
      to launch a build for iOS, Android or web.
2. Once a build job has completed, click on it to open the job's page. On the right side panel, use the 'Job artifacts'
   section to download the output files for the build (`.ipa`, `.apk` or web files). App files can be used to install the app directly
   on your device, or can be sent to yourself via Firebase App Distribution in your personal Firebase project.

### Opal App Scripts

Commands for developer convenience can be found in the [package.json](./package.json) file (in the `"scripts"` section).
Take some time to understand what they do, to help you manipulate the project better.

Note that these commands are explicitly related in terms of dependent steps, so once you understand the structure,
you may choose to run them differently. For instance, the command:

```shell
# Build and run in iOS
npm run start:app:ios --env=dev
```

Calls in sequence `npm run prepare:app && npm run build:web && cordova run ios`, carrying along the `--env=dev` variable as it goes.
You may choose to simply run `cordova run ios`, if you know there is a current valid Cordova build.

## Troubleshooting

### Installation issues

If you are getting errors during your installation, here are some things you can try:

- If you got unexpected errors in the developer console, and the app looks jumbled, it is likely that one of the packages used by Opal was not properly installed.
- If one or many packages didn't install correctly, one of the reasons below may be preventing `npm install` from installing the packages correctly. [Note: if you want to try installing the packages again, you can navigate to your local qplus repository and delete the folder `node_modules`. Then, in the root of the repository, run `npm install`. Npm will detect that you deleted the folder and install the packages again.] You may be having one of the following problems:
  - You don't have the required permissions to perform the installation. Make sure you are logged in as an administrator on your computer, and try re-installing the packages. If you have a Mac, precede your npm commands with `sudo` to run the command with administrator permissions.
  - You have an extra firewall or security plugin installed, which is preventing the packages from installing. For example, the browser extension Ghostery is known to interfere with installation. Try disabling firewalls and security plugins and re-installing the packages.
  - Your computer security is too strong. For example, newer Mac devices running MacOS High Sierra or newer have been known to prevent some packages from installing. For newer Macs, follow the instructions on [this website](https://www.imore.com/how-turn-system-integrity-protection-macos) to turn off System Integrity Protection. Then, try re-installing the packages using the instructions above. Don't forget to re-enable System Integrity Protection once you're done.
  - You have a too recent (or old) version of node installed. Try installing the version recommended above, and re-install the packages.
- If you got an error from `npm install` like `UNABLE_TO_GET_ISSUER_CERT_LOCALLY` or you are behind a firewall, you can try the following commands:
  - Run `npm config set strict-ssl false` and `set NODE_TLS_REJECT_UNAUTHORIZED=0` on the terminal. If this solution worked, you have to run these two commands again for the listener's installation. You also need to run `set NODE_TLS_REJECT_UNAUTHORIZED=0` everytime you restart the terminal.

If at this point you have been unable to install everything properly, reach out to an Opal team member for help.

### Build issues

- If you get the following error from Cordova: `Current working directory is not a Cordova-based project`, create an empty `www` folder in your project. You may delete this folder and re-create it.
- If you get the following error on Windows machine: `EBUSY: resource busy or locked, unlink '\google-services.json'`, go to your task manager, and kill all `Java(TM) Platform SE Binary` processes (select the processes and click on `End Task`).
- If you're unable to delete the `platforms` folder on Windows, follow the step above to kill the Java binary processes.
  If this fails, reboot your machine.
- If you have problems building the app, try to delete the `platforms` and `plugins` directories.
  - iOS: In some cases, it might even be necessary to delete the cached CocoaPods. For example, when updating a Cordova plugin to a newer version. Follow the [instructions on how to do this](https://stackoverflow.com/a/64040015).

### White (or gray) screen of death

If you get a white (or gray) screen of death this is most likely due to a JavaScript error.

#### iOS

Open Safari and navigate to Develop -> Your device.
There should be an inspectable application being listed (e.g., "localhost - index.html").
After selecting it, you get a web inspector window that you can use to troubleshoot, test, etc.

#### Android

Using Chrome, go to `chrome://inspect/#devices`.

## Testing

### Testing with a rooted device (Android)

In order to test that the jailbreak/root detection works correctly you need to simulate a rooted device.
Android Studio allows you to create a [rooted virtual device](https://infosecwriteups.com/get-yourself-a-rooted-android-virtual-device-avd-fb443d590dfa).
Basically, create a new device and choose an image without Google APIs.

### Running the tests

Tests should be written for all new features. It's important to maintain this effort to avoid any code regression.

### Running MobSF to analyze the app builds (static and dynamic analysis)

In order to analyze the app builds for security issues you can run [MobSF](https://github.com/MobSF/Mobile-Security-Framework-MobSF).
Follow the [instructions](https://github.com/MobSF/Mobile-Security-Framework-MobSF#documentation) to run it as a container and open the web UI on the exposed port in your browser.
You can then upload the iOS (`.ipa`) or Android (`.apk`) build and have it analyzed.

## Best Practices

1) When developing in the app, please follow [John Papa's Style Guide](https://github.com/johnpapa/angular-styleguide/blob/master/a1/README.md)
2) Any new features should be unit tested
3) Any new features should be documented using JSDoc format
4) Any new features should be added to the Wiki
5) Follow this [branching model](http://nvie.com/posts/a-successful-git-branching-model/)

## Frameworks used

- [AngularJS](https://angularjs.org/) - The web framework used
- [Webpack](https://webpack.js.org/) - A package bundler and task manager
- [OnsenUI](https://onsen.io/) - The mobile UI framework used
- [Cordova](https://cordova.apache.org/) - The mobile application framework used
- [Node.JS](https://nodejs.org/en/) - Runtime environment for our server-side code

## Authors

- **David Herrera**
- **Robert Maglieri**
- **James Brace**
- **Yick Mo**
- **Stacey Beard**

## License

This project is licensed under the MIT License.

## Acknowledgments

- Medical Physics department at the MUHC for providing a space to work in
- Cedar's Cancer Centre
- Laurie Hendren, John Kildea, and Tarek Hijal for founding the initiative
- All the McGill students who have graciously contributed to the project development

default:
  tags:
    - macos

workflow:
  rules:
    - if: $CI_COMMIT_TAG ~= /^build-(?:dev|local|preprod|prod|staging)-(?:all|android|ios).*$/
      variables:
        # TODO extract variables from the tag regex above
        MY_VARIABLE: "value"

stages:
  - build

before_script:
  - uname -a
  - npm -v
  # install cordova locally
  - npm install cordova
  - npm install

build:android:
  stage: build
  script:
    - java -version
    - gradle -v
    - npm run build:app:android:device --env=staging
    - mv "./platforms/android/app/build/outputs/apk/debug/app-debug.apk" "opal-staging.apk"
  artifacts:
    expire_in: 1 day
    paths:
      - opal-staging.apk

build:ios:
  stage: build
  script:
    # fixes Bus Error when cordova invokes pod install
    # see: https://stackoverflow.com/a/70581304
    - gem install --user-install ffi -- --enable-libffi-alloc
    - npm run build:app:ios:device --env=staging
    - mv "./platforms/ios/build/device/Opal Staging.ipa" "opal-staging.ipa"
  artifacts:
    expire_in: 1 day
    paths:
      - opal-staging.ipa

default:
  tags:
    - macos

workflow:
  rules:
    - if: $CI_COMMIT_TAG =~ /^build-(?:[a-zA-Z]+)-(?:all|android|ios)(?:-.*)?$/

stages:
  - build
    
build:prepare:
  stage: build
  variables:
    FLAGS: '-al'
    LS_CMD: 'ls "$FLAGS"'
    HELLO: 'Hello world!'
  script:
    - echo "$HELLO"
    - 'eval "$LS_CMD"'
    - eval "$LS_CMD"
    - echo "$CI_COMMIT_TAG"
    - echo $CI_COMMIT_TAG
    - TAG_PARAMS=$(echo "$CI_COMMIT_TAG" | sed -r 's/-/ /g')
    - echo "$TAG_PARAMS"
    - set -- $TAG_PARAMS
    - echo "$1"
    - echo "$2"
    - echo "$3"
    - ENV="$2"
    - PLATFORM="$3"
    - echo "ENV=$ENV"
    - echo "PLATFORM=$PLATFORM"

.build:android:
  stage: build
  before_script:
    - uname -a
    - npm -v
    - npm install
  script:
    - java -version
    - gradle -v
    - npm run build:app:android:device --env=dev
    - mv "./platforms/android/app/build/outputs/apk/debug/app-debug.apk" "opal-dev.apk"
  artifacts:
    expire_in: 1 day
    paths:
      - opal-dev.apk

.build:ios:
  stage: build
  before_script:
    - uname -a
    - npm -v
    - npm install
  script:
    # fixes Bus Error when cordova invokes pod install
    # see: https://stackoverflow.com/a/70581304
    - gem install --user-install ffi -- --enable-libffi-alloc
    - npm run build:app:ios:device --env=dev
    - mv "./platforms/ios/build/device/Opal Dev.ipa" "opal-dev.ipa"
  artifacts:
    expire_in: 1 day
    paths:
      - opal-dev.ipa

# You can override the included template(s) by including variable overrides
# SAST customization: https://docs.gitlab.com/ee/user/application_security/sast/#customizing-the-sast-settings
# Secret Detection customization: https://docs.gitlab.com/ee/user/application_security/secret_detection/#customizing-settings
# Dependency Scanning customization: https://docs.gitlab.com/ee/user/application_security/dependency_scanning/#customizing-the-dependency-scanning-settings
# Container Scanning customization: https://docs.gitlab.com/ee/user/application_security/container_scanning/#customizing-the-container-scanning-settings
# Note that environment variables can be set in several places
# See https://docs.gitlab.com/ee/ci/variables/#cicd-variable-precedence
default:
  tags:
  - macos
workflow:
  rules:
  - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  - if: "$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS"
    when: never
  - if: "$CI_COMMIT_BRANCH"
variables:
  ENV: dev
  FIREBASE_APP_ANDROID: "$FIREBASE_APP_DEV_ANDROID"
  FIREBASE_APP_IOS: "$FIREBASE_APP_DEV_IOS"
  FIREBASE_GROUP: general
stages:
- build
- deploy
- test
check dependencies:
  stage: ".pre"
  rules:
  - when: always
  script:
  - npm -v
  - npm ci --prefer-offline
build android:
  stage: build
  rules:
  - if: "$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH"
    when: always
  - when: manual
  before_script:
  - npm -v
  - npm ci --prefer-offline
  script:
  - java -version
  - gradle -v
  - echo "$ENV"
  - npm run build:app:android:device --env=$ENV
  - mv "./platforms/android/app/build/outputs/apk/debug/app-debug.apk" "opal-$ENV.apk"
  artifacts:
    expire_in: 1 day
    paths:
    - opal-$ENV.apk
build ios:
  stage: build
  rules:
  - if: "$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH"
    when: always
  - when: manual
  before_script:
  - npm -v
  - npm ci --prefer-offline
  script:
  - gem install --user-install ffi -- --enable-libffi-alloc
  - echo "$ENV"
  - npm run build:app:ios:device:ci --env=dev --devteam=$IOS_DEVELOPMENT_TEAM
  - mv ./platforms/ios/build/device/*.ipa "opal-$ENV.ipa"
  artifacts:
    expire_in: 1 day
    paths:
    - opal-$ENV.ipa
".deploy to firebase":
  stage: deploy
  before_script:
  - RELEASE_NOTES="Build created and deployed by GitLab CI/CD for environment '$ENV'
    on $(git log --format=short -n 1)"
  - echo "$RELEASE_NOTES"
deploy android to firebase:
  extends: ".deploy to firebase"
  rules:
  - if: "$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH"
    when: always
  script:
  - firebase appdistribution:distribute opal-$ENV.apk --app $FIREBASE_APP_ANDROID
    --release-notes "$RELEASE_NOTES" --groups $FIREBASE_GROUP
  needs:
  - job: build android
deploy ios to firebase:
  extends: ".deploy to firebase"
  rules:
  - if: "$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH"
    when: always
  script:
  - firebase appdistribution:distribute opal-$ENV.ipa --app $FIREBASE_APP_IOS --release-notes
    "$RELEASE_NOTES" --groups $FIREBASE_GROUP
  needs:
  - job: build ios
sast:
  stage: test
include:
- template: Security/SAST.gitlab-ci.yml
